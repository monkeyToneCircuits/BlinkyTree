name: Build BlinkyTree Firmware

on:
  push:
    paths:
      - 'config.yaml'
      - 'songs/**'
      - 'src/**'
      - 'lib/**'
      - 'platformio.ini'
      - '.github/workflows/build.yml'
  pull_request:
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
        
    - name: Set up PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          ~/.cache/pip
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: Install PlatformIO Core
      run: pip install --upgrade platformio
      
    - name: Generate audio code from MusicXML
      run: python scripts/generate_audio_code.py
      
    - name: Build firmware
      run: pio run --environment attiny85_avrispv2
      
    - name: Get firmware info
      id: firmware_info
      run: |
        echo "Firmware build complete!"
        echo "firmware_path=.pio/build/attiny85_avrispv2/firmware.hex" >> $GITHUB_OUTPUT
        
        # Get memory usage using pio
        if [ -f .pio/build/attiny85_avrispv2/firmware.elf ]; then
          echo "=== Memory Usage ===" >> $GITHUB_STEP_SUMMARY
          pio run -e attiny85_avrispv2 -t size >> $GITHUB_STEP_SUMMARY
        fi
        
        # Get timestamp
        echo "build_date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        
    - name: Upload firmware hex file
      uses: actions/upload-artifact@v4
      with:
        name: BlinkyTree_firmware_${{ steps.firmware_info.outputs.build_date }}
        path: |
          .pio/build/attiny85_avrispv2/firmware.hex
          .pio/build/attiny85_avrispv2/firmware.elf
        retention-days: 90
        
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          .pio/build/attiny85_avrispv2/firmware.hex
          .pio/build/attiny85_avrispv2/firmware.elf
        body: |
          ## BlinkyTree Firmware Release
          
          **Build Date:** ${{ steps.firmware_info.outputs.build_date }}
          
          ### Installation
          1. Download `firmware.hex` from the assets below
          2. Upload to ATtiny85 using AVR programmer (AVRISPv2 or Arduino as ISP)
          3. Use `avrdude` or PlatformIO to flash:
             ```
             pio run --target upload --environment attiny85_avrispv2 --upload-port COM<X>
             ```
          
          ### Configuration
          This firmware was built with the songs configured in `config.yaml`.
          To customize songs:
          1. Fork this repository
          2. Edit `config.yaml` to enable/disable songs and adjust playback settings
          3. Add your own MusicXML files to `songs/` folder
          4. GitHub Actions will automatically build your custom firmware
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build summary
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Firmware:** attiny85_avrispv2" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Downloads" >> $GITHUB_STEP_SUMMARY
        echo "- firmware.hex (for uploading to ATtiny85)" >> $GITHUB_STEP_SUMMARY
        echo "- firmware.elf (with debug symbols)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Songs Included" >> $GITHUB_STEP_SUMMARY
        python3 -c "
        import yaml
        with open('config.yaml', 'r') as f:
            config = yaml.safe_load(f)
        songs = config.get('songs', {})
        for name, cfg in songs.items():
            if cfg.get('enabled', False):
                print(f'- {name}')
        " >> $GITHUB_STEP_SUMMARY
